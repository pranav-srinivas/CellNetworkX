<!DOCTYPE html>
<meta charset="utf-8">

<script type="text/javascript" src="http://d3js.org/d3.v3.min.js"></script>

<div id="chart"></div>

<body>

<script type="text/javascript">

var w = window.innerWidth;
var h = window.innerHeight;
var fill = d3.scale.category20();
var currFileName = "hsa05200.json";
var prevFileName = [ ];

var svg = d3.select("#chart")
            .append("svg:svg");

svg.attr("width", w)
   .attr("height", h);

svg.attr("pointer-events", "all");

var zoomer = d3.behavior.zoom().on("zoom", redraw);
zoomer.translate([0, 0]).scale(1);
            
var vis = svg.append('svg:g')
             .call(zoomer)
             .append('svg:g');

function redraw() {
  console.log("here", d3.event.translate, d3.event.scale);
  vis.attr("transform",
      "translate(" + d3.event.translate + ")"
      + " scale(" + d3.event.scale + ")");
}

var draw = function(nodes,links) {
  var force = d3.layout.force()
      .charge(-100)
      .linkDistance(50)
      .nodes(nodes)
      .links(links)
      .size([w, h])
      .start();

  var link = vis.selectAll("line.link")
      .data(links)
      .enter().append("svg:line")
      .attr("class", "link")
      .style("stroke", function(d) { 
      if (d.subtype.name == "inhibition")
  return "red";
              if (d.subtype.name == "activation")
                  return "green";
              if (d.subtype.name == "phosphorylation")
  return "yellow";
              return "blue";
  })

      .style("stroke-width", function(d) { return 2; })
      .attr("x1", function(d) { return d.source.x; })
      .attr("y1", function(d) { return d.source.y; })
      .attr("x2", function(d) { return d.target.x; })
      .attr("y2", function(d) { return d.target.y; });

  var node = vis.selectAll("circle.node")
      .data(nodes)
      .enter().append("svg:circle")
      .attr("class", "node")
      .attr("cx", function(d) { return d.x; })
      .attr("cy", function(d) { return d.y; })
      .attr("r",  function(d) {
        if (d.type == "map") return 20;
        return 10;
      })
      .style("fill", function(d) { return fill(d.id); })
      .call(force.drag)

  node.append("svg:title")
      .text(function(d) { return d.graphics.name; });

  node.on("mouseover", function(d) {
    d3.select(this).style("fill", "red");
  });

  node.on("mouseout", function(d) { 
    d3.select(this).style("fill", fill(d.id));
  }); 

  node.on("click", function(d) { showDetail(d) });

  node.on("dblclick", function(d) { showDetail(d) });
  vis.style("opacity", 1e-6)
     .transition()
     .duration(1000)
     .style("opacity", 1);

  force.on("tick", function() {
    link.attr("x1", function(d) { return d.source.x; })
        .attr("y1", function(d) { return d.source.y; })
        .attr("x2", function(d) { return d.target.x; })
        .attr("y2", function(d) { return d.target.y; });

    node.attr("cx", function(d) { return d.x; })
        .attr("cy", function(d) { return d.y; });
  });
};

resetGraphics = function()
{
  d3.select("svg").remove();
  zoomer = d3.behavior.zoom().on("zoom", redraw);
  zoomer.translate([0, 0]).scale(1);
  svg = d3.select("#chart")
          .append("svg:svg");

  svg.attr("width", w)
     .attr("height", h);

  svg.attr("pointer-events", "all");

  vis = svg.append('svg:g')
  .call(zoomer)
  .append('svg:g');
}

showDetail = function(d) 
{
  if (d.type == "map") {
      var mapName = d.name;

      var idx = prevFileName.length;
      prevFileName[idx] = currFileName;
      currFileName = mapName.substr(5) + ".json";
      
      resetGraphics();
      loadJSON(currFileName);

  }
 }

loadJSON = function(filename) {
        
    d3.json(filename, function(data) {

      var nodes = data.pathway.entry;
      var links = data.pathway.relation;

      document.title = data.pathway.title;

      // Create Node to Index map
      var nodeId2Index = { };
      var nodeIdx = 0;
      nodes.forEach(function(n) {
        nodeId2Index[n.id] = nodeIdx;
        ++nodeIdx;
      });
    
        // Assign source and target for each link
     links.forEach(function(l) {
       l.source = nodeId2Index[l.entry1];
       l.target = nodeId2Index[l.entry2];
     });

   draw(nodes, links)

});

}

loadJSON(currFileName);

goBack = function() {

    if(prevFileName == 0) return;
    var idx = prevFileName.length - 1;
    currFileName  = prevFileName[idx];
    prevFileName.splice(idx, 1);
    resetGraphics();
    loadJSON(currFileName);
}
</script>

<div id= "option">
  <input name ="backButton"
         type = "button"
         style ="width: 100px;font-size: 120px;font-family: Helvetica"
         value ="Back"
         onclick= "goBack()" />
</div>

</body>

</html>
